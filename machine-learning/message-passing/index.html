
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.1.4">
    
    
      
        <title>Computational Representations of Message Passing - Essays on Data Science</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.358818c7.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.f0267088.min.css">
        
          
          
          <meta name="theme-color" content="#02a6f2">
        
      
    
    
    
      
        
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="https://unpkg.com/mermaid@7.1.2/dist/mermaid.css">
    
      <link rel="stylesheet" href="../../css/ansi-colours.css">
    
      <link rel="stylesheet" href="../../css/jupyter-cells.css">
    
      <link rel="stylesheet" href="../../css/pandas-dataframe.css">
    
    
      
        
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-12498603-3","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}),document.addEventListener("DOMContentSwitch",function(){ga("send","pageview",document.location.pathname)})</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="light-blue" data-md-color-accent="light-blue">
      
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#computational-representations-of-message-passing" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="../.." title="Essays on Data Science" class="md-header-nav__button md-logo" aria-label="Essays on Data Science">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Essays on Data Science
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Computational Representations of Message Passing
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/ericmjl/essays-on-data-science/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    ericmjl/essays-on-data-science
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Essays on Data Science" class="md-nav__button md-logo" aria-label="Essays on Data Science">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Essays on Data Science
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/ericmjl/essays-on-data-science/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    ericmjl/essays-on-data-science
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Computing
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Computing" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon"></span>
        Computing
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../computing/recursion/" class="md-nav__link">
      Recursion
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Machine Learning
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Machine Learning" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon"></span>
        Machine Learning
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../computational-bayesian-stats/" class="md-nav__link">
      An Introduction to Probability and Computational Bayesian Statistics
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../markov-models/" class="md-nav__link">
      Markov Models From The Bottom Up, with Python
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../generating-markov-chains-dirichlet/" class="md-nav__link">
      Dirichlet Processes and Hidden Markov Model Transition Matrices
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Computational Representations of Message Passing
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="./" class="md-nav__link md-nav__link--active">
      Computational Representations of Message Passing
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction-to-message-passing" class="md-nav__link">
    Introduction to Message Passing
  </a>
  
    <nav class="md-nav" aria-label="Introduction to Message Passing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#functions-on-nodes" class="md-nav__link">
    Functions on Nodes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#message-passing" class="md-nav__link">
    Message Passing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#computational-implementations-of-message-passing" class="md-nav__link">
    Computational Implementations of Message Passing
  </a>
  
    <nav class="md-nav" aria-label="Computational Implementations of Message Passing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#object-oriented-implementation" class="md-nav__link">
    Object-Oriented Implementation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#linear-algebra-implementation" class="md-nav__link">
    Linear Algebra Implementation
  </a>
  
    <nav class="md-nav" aria-label="Linear Algebra Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adjacency-variant-1-n-degree-adjacency-matrix" class="md-nav__link">
    Adjacency Variant 1: N-degree adjacency matrix
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adjacency-variant-2-graph-laplacian-matrix" class="md-nav__link">
    Adjacency Variant 2: Graph laplacian matrix
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#message-passing-on-multiple-graphs" class="md-nav__link">
    Message Passing on Multiple Graphs
  </a>
  
    <nav class="md-nav" aria-label="Message Passing on Multiple Graphs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#implementation-1-for-loops-over-pairs-of-adjacency-and-feature-matrices" class="md-nav__link">
    Implementation 1: For-loops over pairs of adjacency and feature matrices
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-2-sparse-matrices" class="md-nav__link">
    Implementation 2: Sparse Matrices
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-3-size-batched-matrix-multiplication" class="md-nav__link">
    Implementation 3: Size-batched matrix multiplication
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-4-batched-padded-matrix-multiplication" class="md-nav__link">
    Implementation 4: Batched padded matrix multiplication
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#concluding-words" class="md-nav__link">
    Concluding Words
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#acknowledgments" class="md-nav__link">
    Acknowledgments
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#appendix" class="md-nav__link">
    Appendix
  </a>
  
    <nav class="md-nav" aria-label="Appendix">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#equivalence-between-padded-and-non-padded-message-passing" class="md-nav__link">
    Equivalence between padded and non-padded message passing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#thank-you-for-reading" class="md-nav__link">
    Thank you for reading!
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../reimplementing-models/" class="md-nav__link">
      Reimplementing and Testing Deep Learning Models
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Miscellaneous
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Miscellaneous" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon"></span>
        Miscellaneous
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../miscellaneous/dashboarding-landscape/" class="md-nav__link">
      A Review of the Python Data Science Dashboarding Landscape in 2019
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../miscellaneous/learning-to-learn/" class="md-nav__link">
      How I Learned to Learn
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../miscellaneous/pydata-landscape/" class="md-nav__link">
      An Opinionated and Unofficial Guide to the PyData Ecosystem
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../miscellaneous/static-sites-on-dokku/" class="md-nav__link">
      Static Sites and Apps On Your Own Dokku Server
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Newsletter
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Newsletter" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        <span class="md-nav__icon md-icon"></span>
        Newsletter
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5-1" type="checkbox" id="nav-5-1">
    
    <label class="md-nav__link" for="nav-5-1">
      2020
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="2020" data-md-level="2">
      <label class="md-nav__title" for="nav-5-1">
        <span class="md-nav__icon md-icon"></span>
        2020
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../newsletter/2020/05-may/" class="md-nav__link">
      May
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../newsletter/2020/06-june/" class="md-nav__link">
      June
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../newsletter/2020/07-july/" class="md-nav__link">
      July
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../newsletter/2020/08-august/" class="md-nav__link">
      August
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../newsletter/2020/09-september/" class="md-nav__link">
      September
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Software Skills
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Software Skills" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        <span class="md-nav__icon md-icon"></span>
        Software Skills
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../software-skills/" class="md-nav__link">
      Importance
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../software-skills/code-formatting/" class="md-nav__link">
      Formatting your code
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../software-skills/documentation/" class="md-nav__link">
      Documenting your code
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../software-skills/environment-variables/" class="md-nav__link">
      A Data Scientist's Guide to Environment Variables
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../software-skills/refactoring/" class="md-nav__link">
      Refactoring your code
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../software-skills/testing/" class="md-nav__link">
      Testing your code
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Terminal Hacks
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Terminal Hacks" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        <span class="md-nav__icon md-icon"></span>
        Terminal Hacks
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../terminal/cli-tools/" class="md-nav__link">
      Tools and Upgrades for your CLI
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../terminal/pre-commits/" class="md-nav__link">
      Using pre-commit git hooks to automate code checks
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      Workflow
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Workflow" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        <span class="md-nav__icon md-icon"></span>
        Workflow
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../workflow/code-review/" class="md-nav__link">
      Practicing Code Review
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../workflow/effective-commit-messages/" class="md-nav__link">
      Effective Git Commits in Data Science
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../workflow/gitflow/" class="md-nav__link">
      Principled Git-based Workflow in Collaborative Data Science Projects
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../supporters/" class="md-nav__link">
      Supporters
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction-to-message-passing" class="md-nav__link">
    Introduction to Message Passing
  </a>
  
    <nav class="md-nav" aria-label="Introduction to Message Passing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#functions-on-nodes" class="md-nav__link">
    Functions on Nodes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#message-passing" class="md-nav__link">
    Message Passing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#computational-implementations-of-message-passing" class="md-nav__link">
    Computational Implementations of Message Passing
  </a>
  
    <nav class="md-nav" aria-label="Computational Implementations of Message Passing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#object-oriented-implementation" class="md-nav__link">
    Object-Oriented Implementation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#linear-algebra-implementation" class="md-nav__link">
    Linear Algebra Implementation
  </a>
  
    <nav class="md-nav" aria-label="Linear Algebra Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adjacency-variant-1-n-degree-adjacency-matrix" class="md-nav__link">
    Adjacency Variant 1: N-degree adjacency matrix
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adjacency-variant-2-graph-laplacian-matrix" class="md-nav__link">
    Adjacency Variant 2: Graph laplacian matrix
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#message-passing-on-multiple-graphs" class="md-nav__link">
    Message Passing on Multiple Graphs
  </a>
  
    <nav class="md-nav" aria-label="Message Passing on Multiple Graphs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#implementation-1-for-loops-over-pairs-of-adjacency-and-feature-matrices" class="md-nav__link">
    Implementation 1: For-loops over pairs of adjacency and feature matrices
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-2-sparse-matrices" class="md-nav__link">
    Implementation 2: Sparse Matrices
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-3-size-batched-matrix-multiplication" class="md-nav__link">
    Implementation 3: Size-batched matrix multiplication
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-4-batched-padded-matrix-multiplication" class="md-nav__link">
    Implementation 4: Batched padded matrix multiplication
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#concluding-words" class="md-nav__link">
    Concluding Words
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#acknowledgments" class="md-nav__link">
    Acknowledgments
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#appendix" class="md-nav__link">
    Appendix
  </a>
  
    <nav class="md-nav" aria-label="Appendix">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#equivalence-between-padded-and-non-padded-message-passing" class="md-nav__link">
    Equivalence between padded and non-padded message passing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#thank-you-for-reading" class="md-nav__link">
    Thank you for reading!
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/ericmjl/essays-on-data-science/edit/master/docs/machine-learning/message-passing.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="computational-representations-of-message-passing">Computational Representations of Message Passing</h1>
<p><strong>Abstract:</strong> Message passing on graphs,
also known as graph convolutions,
have become a popular research topic.
In this piece,
I aim to provide a short technical primer
on ways to implement message passing on graphs.
The goal is to provide clear pedagogy
on what message passing means mathematically,
and hopefully point towards cleaner computational implementations
of the key algorithmic pieces.</p>
<p><strong>Assumed knowledge:</strong>
We assume our reader has familiarity with elementary graph concepts.
More specifically, the terms “graph”, “nodes”, and “edges”
should be familiar terms.
Code examples in this technical piece will be written
using the Python programming language,
specifically using Python 3.7, NumPy 1.17 (in JAX), and NetworkX 2.2.</p>
<h2 id="introduction-to-message-passing">Introduction to Message Passing</h2>
<h3 id="functions-on-nodes">Functions on Nodes</h3>
<p>Message passing starts with a “function defined over nodes”,
which we will denote here as <span><span class="MathJax_Preview">f(v)</span><script type="math/tex">f(v)</script></span> (for “function of node/vertex v”).
What is this, one might ask?
In short,
this is nothing more than a numeric value of some kind
attached to every node in a graph.
This value could be scalar, vector, matrix, or tensor.</p>
<p>The semantic meaning of that value
is typically defined by the application domain
that the graph is being used in.
As a concrete example,
in molecules, a “function” defined over the molecular graph
could be the scalar-valued proton number.
Carbon would be represented by the function <span><span class="MathJax_Preview">f(v) = 6</span><script type="math/tex">f(v) = 6</script></span>.
Alternatively, it could be a vector of values
encompassing both the atomic mass and the number of valence electrons.
In this case, carbon would be represented by the function <span><span class="MathJax_Preview">f(v) = (6, 4)</span><script type="math/tex">f(v) = (6, 4)</script></span>.</p>
<p>Visually, one might represent it as follows:</p>
<!-- \<FIGURE\> -->
<p><img alt="" src="../message-passing-figures/figure-msg-passing-carbon-methane.png" /></p>
<h3 id="message-passing">Message Passing</h3>
<p>What then is message passing, or,
as the deep learning community has adopted, “graph convolution”?
At its core, message passing is nothing more
than a generic mathematical operation
defined between a node’s function value
and its neighbors function value.</p>
<p>As an example,
one may define a message passing operation
to be the summation the function evaluated at a node
with the function evaluated on its neighbor’s nodes.
Here is a simplistic example,
shown using a scalar on water:</p>
<p><img alt="" src="../message-passing-figures/figure-msg-passing-water.png" /></p>
<p>Summation is not the only message passing operation that can be defined.
In principle,
given any node (or vertex) <span><span class="MathJax_Preview">v</span><script type="math/tex">v</script></span> and its neighbors <span><span class="MathJax_Preview">N(v)</span><script type="math/tex">N(v)</script></span> values,
we may write down a generic function <span><span class="MathJax_Preview">f(v, N(v))</span><script type="math/tex">f(v, N(v))</script></span>
that defines how the function value on each node
is to be shared with its neighbors.</p>
<h2 id="computational-implementations-of-message-passing">Computational Implementations of Message Passing</h2>
<p>For simplicity,
let us stay with the particular case
where the message passing operation is defined as
the summation of one’s neighbors values with one’s values.</p>
<h3 id="object-oriented-implementation">Object-Oriented Implementation</h3>
<p>With this definition in place,
we may then define a message passing operation in Python as follows:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">message_passing</span><span class="p">(</span><span class="n">G</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Object-oriented message passing operation.&quot;&quot;&quot;</span>

    <span class="n">G_new</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">new_value</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>  <span class="c1"># assuming the value is stored under this key</span>
        <span class="n">neighbors</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">neighbor</span> <span class="ow">in</span> <span class="n">neighbors</span><span class="p">:</span>
            <span class="n">new_value</span> <span class="o">+=</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">neighbor</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
        <span class="n">G_new</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_value</span>
    <span class="k">return</span> <span class="n">G</span>
</code></pre></div>
</td></tr></table>
<p>Thinking about computational considerations,
we would naturally consider this implementation to be slow,
because it involves a for-loop over Python objects.
If we had multiple graphs
over which we wanted message passing to be performed,
the type-checking overhead in Python will naturally accumulate,
and may even dominate.</p>
<h3 id="linear-algebra-implementation">Linear Algebra Implementation</h3>
<p>How might we speed things up? As it turns out, linear algebra may be useful.</p>
<p>We know that every graph may be represented as an adjacency matrix <code>A</code>,
whose shape is <code>(n_nodes, n_nodes)</code>.
As long as we maintain proper node ordering,
we may also define a compatibly-shaped matrix <code>F</code> for node function values,
whose shape is <code>(n_nodes, n_features)</code>.</p>
<p>Taking advantage of this,
in order define the “self plus neighbors” message passing operation
in terms of linear algebra operations,
we may then modify <code>A</code> by adding to it a diagonal matrix of ones.
(In graph terminology,
this is equivalent to adding a self-loop to the adjacency matrix.)</p>
<p>Then, message passing,
as defined above,
is trivially the dot product of <code>A</code> and <code>F</code>:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">message_passing</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">F</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Message passing done by linear algebra.</span>

<span class="sd">    :param A: Adjacency-like matrix, whose shape is (n_nodes, n_nodes).</span>
<span class="sd">    :param F: Feature matrix, whose shape is (n_nodes, n_features).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>In principle, variants on the adjacency matrix are possible.
The only hard requirement for the matrix <code>A</code>
is that it has the shape <code>(n_nodes, n_nodes)</code>.</p>
<h4 id="adjacency-variant-1-n-degree-adjacency-matrix">Adjacency Variant 1: N-degree adjacency matrix</h4>
<p>The adjacency matrix represents connectivity by degree 1.
If we take the second matrix power of the adjacency matrix,
we get back the connectivity of nodes
at two degrees of separation away.
More generically:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">n_degree_adjacency</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the n-degree of separation adjacency matrix.</span>

<span class="sd">    :param A: Adjacency matrix, of shape (n_nodes, n_nodes)</span>
<span class="sd">    :param n: Number of degrees of separation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">matrix_power</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>Performing message passing using the N-degree adjacency matrix
effectively describes sharing of information
between nodes that are N-degrees of separation apart,
skipping intermediate neighbors.</p>
<h4 id="adjacency-variant-2-graph-laplacian-matrix">Adjacency Variant 2: Graph laplacian matrix</h4>
<p>The graph laplacian matrix is defined as
the diagonal degree matrix <code>D</code>
(where the diagonal entries are the degree of each node)
minus the adjacency matrix <code>A</code>: <code>L = D - A</code>.</p>
<p>This matrix is the discrete analog to the Laplacian operator,
and can give us information
about the discrete gradient between a node and its neighbors.</p>
<h2 id="message-passing-on-multiple-graphs">Message Passing on Multiple Graphs</h2>
<p>Thus far,
we have seen an efficient implementation
of message passing on a single graph
using linear algebra.</p>
<p>How would one perform message passing on multiple graphs, though?</p>
<p>This is a question
that has applications in graph neural networks
(especially in cheminformatics).
For the learning task where one has a batch of graphs,
and the supervised learning task is
to predict a scalar (or vector) value per graph,
knowing how to efficiently message pass over multiple graphs
is crucial to developing a performant graph neural network model.</p>
<p>The challenge here, though,
is that graphs generally are of variable size,
hence it is not immediately obvious how to “tensorify” the operations.</p>
<p>Let us look at a few alternatives,
starting with the most obvious (but also most inefficient),
building towards more efficient solutions.</p>
<h3 id="implementation-1-for-loops-over-pairs-of-adjacency-and-feature-matrices">Implementation 1: For-loops over pairs of adjacency and feature matrices</h3>
<p>If we multiple graphs,
they may be represented as a list of feature matrices
and a list of adjacency matrices.
The message passing operation, then,
may be defined by writing a for-loop over pairs of these matrices.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">message_passing</span><span class="p">(</span><span class="n">As</span><span class="p">,</span> <span class="n">Fs</span><span class="p">):</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">A</span><span class="p">,</span> <span class="n">F</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">As</span><span class="p">,</span> <span class="n">Fs</span><span class="p">):</span>
        <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">F</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">outputs</span>
</code></pre></div>
</td></tr></table>
<p>Because of the for-loop,
the obvious downside here
is the overhead induced by running a for-loop over pairs of As and Fs.</p>
<h3 id="implementation-2-sparse-matrices">Implementation 2: Sparse Matrices</h3>
<p>Sparse matrices are an attractive alternative.
Instead of treating graphs as independent samples,
we may treat them as a single large graph on which we perform message passing.
If we order the nodes in our adjacency matrix and feature matrix correctly,
we will end up with a block diagonal adjacency matrix,
and vertically stacked feature matrices.</p>
<p><img alt="" src="../message-passing-figures/figure-message-passing-sparse.png" /></p>
<p>If we prepare the multiple graphs as a large disconnected graph,
then we will have a dense feature matrix of shape <code>(sum(n_nodes), n_feats)</code>,
and a sparse adjacency matrix of shape <code>(sum(n_nodes), sum(n_nodes))</code>.
Message passing then becomes a sparse-dense dot product:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">message_passing</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">F</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">sparse</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>The upside here is that
message passing has been returned back to its natural form (a dot product).
The downsides here are that the data must be prepared as a single large graph,
hence we effectively lose
what one would call the “sample” (or “batch”) dimension.
Additionally, the most widely used deep learning libraries
do not support automatic differentiation
on sparse-dense or dense-sparse dot products,
hence limiting the use of this implementation in deep learning.</p>
<h3 id="implementation-3-size-batched-matrix-multiplication">Implementation 3: Size-batched matrix multiplication</h3>
<p>An alternative way to conceptualize message passing
is to think of graphs of the same size as belonging to a “size batch”.
We may then vertically stack the feature and adjacency matrices
of graphs of the same size together,
and perform a batched matrix multiplication,
ensuring that we preserve the sample/batch dimension in the final result.</p>
<p><img alt="" src="../message-passing-figures/figure-message-passing-graph-size.png" /></p>
<p>In terms of Python code, this requires special preparation of the graphs.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">jax.lax</span> <span class="kn">import</span> <span class="n">batch_matmul</span>

<span class="k">def</span> <span class="nf">feature_matrix</span><span class="p">(</span><span class="n">G</span><span class="p">):</span>
    <span class="c1"># ...</span>
    <span class="k">return</span> <span class="n">F</span>

<span class="k">def</span> <span class="nf">prep_data</span><span class="p">(</span><span class="n">Gs</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="n">adjacency_matrices</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">feature_matrices</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">G</span> <span class="ow">in</span> <span class="n">Gs</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">feature_matrix</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">(</span><span class="n">G</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="n">adjacency_matrices</span><span class="p">[</span><span class="n">size</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
        <span class="n">feature_matrices</span><span class="p">[</span><span class="n">size</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">size</span><span class="p">,</span> <span class="n">As</span> <span class="ow">in</span> <span class="n">adjacency_matrices</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">adjacency_matrices</span><span class="p">[</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">As</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">size</span><span class="p">,</span> <span class="n">Fs</span> <span class="ow">in</span> <span class="n">feature_matrices</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">feature_matrices</span><span class="p">[</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">Fs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">adjacency_matrices</span><span class="p">,</span> <span class="n">feature_matrices</span>

<span class="k">def</span> <span class="nf">message_passing</span><span class="p">(</span><span class="n">As</span><span class="p">,</span> <span class="n">Fs</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">As</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">Fs</span><span class="p">[</span><span class="n">size</span><span class="p">]</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">As</span><span class="p">[</span><span class="n">size</span><span class="p">]</span>

        <span class="n">result</span><span class="p">[</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch_matmul</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
</td></tr></table>
<p>In this implementation,
we use <code>jax.lax.batch_matmul</code>,
which inherently assumes
that the first dimension is the sample/batch dimension,
and that the matrix multiplication happens on the subsequent dimensions.</p>
<p>An advantage here is that the number of loop overhead calls in Python
is reduced to the number of unique graph sizes that are present in the graph.
The disadvantage, though,
is that we have a dictionary data structure that we have to deal with,
which makes data handling in Python less natural
when dealing with linear algebra libraries.</p>
<h3 id="implementation-4-batched-padded-matrix-multiplication">Implementation 4: Batched padded matrix multiplication</h3>
<p>In this implementation,
we prepare the data in a different way.
Firstly, we must know the size of the largest graph ahead-of-time.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">size</span> <span class="o">=</span> <span class="o">...</span>  <span class="c1"># largest graph size</span>
</code></pre></div>
</td></tr></table>
<p>We then pad every graph’s feature matrix with zeros along the node axis
until the node axis is as long as the largest graph size.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">prep_feats</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
    <span class="c1"># F is of shape (n_nodes, n_feats)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span>
        <span class="n">F</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">],</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>We do the same with every adjacency matrix.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">prep_adjs</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
    <span class="c1"># A is of shape (n_nodes, n_nodes)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span>
        <span class="n">A</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="p">],</span>
    <span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>Finally, we simply stack them into the data matrix:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">As</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">prep_adjs</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="k">for</span> <span class="n">A</span> <span class="ow">in</span> <span class="n">As</span><span class="p">]</span>
<span class="n">Fs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">prep_feats</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="k">for</span> <span class="n">F</span> <span class="ow">in</span> <span class="n">Fs</span><span class="p">]</span>
</code></pre></div>
</td></tr></table>
<p>Now, the shapes of our matrices are as follows:</p>
<ul>
<li><code>F</code> takes on the shape <code>(n_graphs, n_nodes, n_feats)</code></li>
<li><code>A</code> takes on the shape <code>(n_graphs, n_nodes, n_nodes)</code></li>
</ul>
<p>If we desire to be semantically consistent with our shapes,
then we might, by convention,
assign the first dimension to be the sample/batch dimension.</p>
<p>Finally, message passing is now trivially defined as a batch matrix multiply:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">message_passing</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">F</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">batch_matmul</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>Visually, this is represented as follows:</p>
<p><img alt="" src="../message-passing-figures/figure-message-passing-batched.png" /></p>
<p>To this author’s best knowledge,
this should be the most efficient implementation of batched message passing
across multiple graphs
that also supports automatic differentiation,
while also maintaining parity with the written equation form,
hence preserving readability.
The problems associated with a for-loop,
sparse matrix multiplication,
and dictionary carries,
are removed.
Moreover, the sample/batch dimension is preserved,
hence it is semantically easy to map each graph
to its corresponding output value.
Given the current state of automatic differentiation libraries,
no additional machinery is necessary to support sparse matrix products.</p>
<p>The only disadvantage that this author can think of
is that zero-padding may not be intuitive at first glance,
and that the data must still be specially prepared and stacked first.</p>
<h2 id="concluding-words">Concluding Words</h2>
<p>This essay was initially motivated
by the myriad of difficult-to-read message passing implementations
present in the deep learning literature.
Frequently,
a for-loop of some kind is invoked,
or an undocumented list data structure is created,
in order to accomplish the message passing operation.
Moreover, the model implementation
is frequently not separated from the data preparation step,
which makes for convoluted
and mutually incompatible implementations
of message passing in neural networks.</p>
<p>It is my hope that while the research field is still in vogue,
a technical piece that advises researchers
on easily-readable and efficient implementations
of message passing on graphs
may help advance research practice.
In particular,
if our code can more closely match the equations listed in papers,
that will help facilitate
communication and verification of model implementations.</p>
<p>To help researchers get started,
an example implementation for the full data preparation
and batched padded matrix multiplies in JAX
is available on GitHub,
archived on Zenodo.</p>
<h2 id="acknowledgments">Acknowledgments</h2>
<p>I thank Rif. A. Saurous
for our discussion at the PyMC4 developer summit in Montreal, QC,
where his laser-like focus on “tensorify everything”
inspired many new thoughts in my mind.</p>
<p>Many thanks to my wife, Nan Li,
who first pointed me to the linear algebra equivalents of graphs.</p>
<p>I also thank David Duvenaud and Matthew J. Johnson
for their pedagogy while they were at Harvard.</p>
<h2 id="appendix">Appendix</h2>
<h3 id="equivalence-between-padded-and-non-padded-message-passing">Equivalence between padded and non-padded message passing</h3>
<p>To readers who may need an example to be convinced
that matrix multiplying the padded matrices
is equivalent to matrix multiplying the originals,
we show the Python example below.</p>
<p>Firstly, without padding:</p>
<div class="highlight"><pre><span></span><code><span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>

<span class="c1"># Value of M</span>
<span class="c1"># DeviceArray([[1, 0],</span>
            <span class="c1">#  [1, 1]], dtype=int32)</span>
</code></pre></div>
<p>And now, with padding:</p>
<div class="highlight"><pre><span></span><code><span class="n">pad_size</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">F_pad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span>
    <span class="n">F</span><span class="p">,</span>
    <span class="n">pad_width</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pad_size</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">A_pad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span>
    <span class="n">A</span><span class="p">,</span>
    <span class="n">pad_width</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pad_size</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pad_size</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="c1"># F_pad:</span>
<span class="c1"># DeviceArray([[1, 0],</span>
<span class="c1">#              [1, 1],</span>
<span class="c1">#              [0, 0],</span>
<span class="c1">#              [0, 0]], dtype=int32)</span>

<span class="c1"># A_pad:</span>
<span class="c1"># DeviceArray([[1, 0, 0, 0],</span>
<span class="c1">#              [0, 1, 0, 0],</span>
<span class="c1">#              [0, 0, 0, 0],</span>
<span class="c1">#              [0, 0, 0, 0]], dtype=int32)</span>

<span class="n">M_pad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A_pad</span><span class="p">,</span> <span class="n">F_pad</span><span class="p">)</span>
<span class="c1"># M_pad:</span>
<span class="c1"># DeviceArray([[1, 0],</span>
<span class="c1">#              [1, 1],</span>
<span class="c1">#              [0, 0],</span>
<span class="c1">#              [0, 0]], dtype=int32)</span>
</code></pre></div>
<h2 id="thank-you-for-reading">Thank you for reading!</h2>
<p>If you enjoyed this essay and would like to receive early-bird access to more,
<a href="https://patreon.com/ericmjl">please support me on Patreon</a>!
A coffee a month sent my way gets you <em>early</em> access to my essays
on a private URL exclusively for my supporters
as well as shoutouts on every single essay that I put out.</p>
<p>Also, I have a free monthly newsletter that I use as an outlet
to share programming-oriented data science tips and tools.
If you'd like to receive it, sign up on <a href="https://tinyletter.com/ericmjl">TinyLetter</a>!</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../generating-markov-chains-dirichlet/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Dirichlet Processes and Hidden Markov Model Transition Matrices
              </div>
            </div>
          </a>
        
        
          <a href="../reimplementing-models/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Reimplementing and Testing Deep Learning Models
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="http://www.shortwhale.com/ericmjl" target="_blank" rel="noopener" title="www.shortwhale.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 8l-8 5-8-5V6l8 5 8-5m0-2H4c-1.11 0-2 .89-2 2v12a2 2 0 002 2h16a2 2 0 002-2V6a2 2 0 00-2-2z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://github.com/ericmjl" target="_blank" rel="noopener" title="github.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://twitter.com/ericmjl" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://linkedin.com/in/ericmjl" target="_blank" rel="noopener" title="linkedin.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.7e0ee788.min.js"></script>
      <script src="../../assets/javascripts/bundle.b3a72adc.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: ['tabs'],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.4ac00218.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      
        <script src="https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js"></script>
      
    
  </body>
</html>